<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Native Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg: #ffffff;
            --text: #1a1a1a;
            --ui-bg: #ffffff;
            --border: #eeeeee;
            --sidebar-width: 280px;
        }

        [data-theme="dark"] {
            --bg: #121212;
            --text: #d1d1d1;
            --ui-bg: #1a1a1a;
            --border: #2c2c2c;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
            line-height: 1.8;
            transition: background 0.3s;
        }

        /* æç®€ä¸Šä¼ é¡µ */
        #upload-page {
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        .upload-box {
            width: 280px; padding: 40px; border: 1px solid var(--border); text-align: center;
        }

        /* é˜…è¯»ç•Œé¢å¸ƒå±€ */
        #reader-page { display: none; }

        .nav-bar {
            position: fixed; top: 0; width: 100%; height: 50px;
            background: var(--ui-bg); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 20px; z-index: 1000;
        }

        /* ä¾§è¾¹æ ç›®å½• */
        #sidebar {
            position: fixed; left: 0; top: 50px; bottom: 0; width: var(--sidebar-width);
            background: var(--ui-bg); border-right: 1px solid var(--border);
            overflow-y: auto; display: none; padding: 20px; z-index: 999;
        }

        .toc-link {
            display: block; padding: 12px 0; border-bottom: 1px solid var(--border);
            cursor: pointer; text-decoration: none; color: var(--text); font-size: 14px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .toc-link:hover { color: #007aff; }

        /* å†…å®¹æ­£æ–‡åŒº */
        #content-area {
            max-width: 750px; margin: 80px auto; padding: 0 20px 100px 20px;
            font-size: 18px;
        }

        /* ä¿®æ­£å†…å®¹ä¸­çš„å›¾ç‰‡ */
        #content-area img {
            max-width: 100%; height: auto; display: block; margin: 20px auto;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 6px 14px; border: 1px solid var(--border);
            background: var(--bg); color: var(--text); cursor: pointer;
            margin-right: 10px; border-radius: 4px; font-size: 13px;
        }
        .btn:hover { background: var(--border); }

        /* é€‚é…ï¼šå†…å®¹ä¸­çš„ ID è·³è½¬ç›®æ ‡å¢åŠ åç§»ï¼Œé˜²æ­¢è¢«é¡¶éƒ¨å¯¼èˆªæ‹¦æŒ¡ä½ */
        section[id], div[id], p[id], span[id] {
            scroll-margin-top: 70px;
        }
    </style>
</head>
<body>

    <div id="upload-page">
        <div class="upload-box">
            <input type="file" id="file-input" accept=".epub">
        </div>
    </div>

    <div id="reader-page">
        <div class="nav-bar">
            <button class="btn" onclick="toggleTOC()">â˜° ç›®å½•</button>
            <button class="btn" onclick="toggleTheme()">ğŸŒ“ æ¨¡å¼</button>
            <button class="btn" onclick="location.reload()">é€€å‡º</button>
            <span id="book-title" style="font-size: 14px; opacity: 0.6; margin-left: 10px;"></span>
        </div>
        
        <div id="sidebar">
            <h3 style="font-size: 16px;">ç›®å½•</h3>
            <div id="toc-list"></div>
        </div>

        <article id="content-area"></article>
    </div>

    <script>
        let blobs = {}; // å­˜å‚¨è§£å‹å‡ºçš„èµ„æº URL

        document.getElementById('file-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const zip = await JSZip.loadAsync(file);
                document.getElementById('upload-page').style.display = 'none';
                document.getElementById('reader-page').style.display = 'block';

                // 1. é¢„å¤„ç†ï¼šå°†æ‰€æœ‰é HTML æ–‡ä»¶ï¼ˆå›¾ç‰‡/CSSç­‰ï¼‰è½¬ä¸º Blob URL
                for (let filename in zip.files) {
                    const fileData = zip.files[filename];
                    if (!fileData.dir) {
                        const content = await fileData.async('blob');
                        blobs[filename] = URL.createObjectURL(content);
                    }
                }

                // 2. è§£æç”µå­ä¹¦ç»“æ„
                const opfPath = await findOPF(zip);
                const baseDir = opfPath.substring(0, opfPath.lastIndexOf('/') + 1);
                const opfText = await zip.file(opfPath).async('text');
                const opfDoc = new DOMParser().parseFromString(opfText, "text/xml");

                // è·å–ä¹¦å
                const title = opfDoc.getElementsByTagName('dc:title')[0]?.textContent || "Unknown Title";
                document.getElementById('book-title').innerText = title;

                // è§£ææ¸…å• (Manifest) å’Œ é˜…è¯»é¡ºåº (Spine)
                const manifest = Array.from(opfDoc.getElementsByTagName('item'));
                const itemrefs = Array.from(opfDoc.getElementsByTagName('itemref'));
                const manifestMap = {};
                manifest.forEach(item => {
                    manifestMap[item.getAttribute('id')] = item.getAttribute('href');
                });

                const container = document.getElementById('content-area');
                const tocList = document.getElementById('toc-list');

                // 3. æŒ‰é¡ºåºåŠ è½½å¹¶æ³¨å…¥ HTML
                for (let ref of itemrefs) {
                    const id = ref.getAttribute('idref');
                    const href = manifestMap[id];
                    const fullPath = normalizePath(baseDir + href);
                    
                    if (zip.file(fullPath)) {
                        let htmlText = await zip.file(fullPath).async('text');
                        
                        const section = document.createElement('section');
                        section.id = href; // å…³é”®ï¼šç”¨æ–‡ä»¶ååš IDï¼Œæ–¹ä¾¿é“¾æ¥è·³è½¬
                        
                        // æ›¿æ¢å†…å®¹ä¸­çš„ç›¸å¯¹èµ„æº
                        section.innerHTML = processHTML(htmlText, baseDir);
                        container.appendChild(section);

                        // ç®€å•çš„ç›®å½•é¡¹ï¼šå–ç¬¬ä¸€ä¸ªæ ‡é¢˜æˆ–æ–‡ä»¶å
                        const firstHeading = section.querySelector('h1, h2, h3');
                        const link = document.createElement('a');
                        link.className = 'toc-link';
                        link.innerText = firstHeading ? firstHeading.innerText.trim() : href;
                        link.onclick = () => {
                            section.scrollIntoView({ behavior: 'smooth' });
                            toggleTOC();
                        };
                        tocList.appendChild(link);
                    }
                }

                // 4. ä¿®å¤ï¼šé“¾æ¥ç‚¹å‡»æ‹¦æˆªå™¨
                container.addEventListener('click', (ev) => {
                    const a = ev.target.closest('a');
                    if (a && a.getAttribute('href')) {
                        const href = a.getAttribute('href');
                        if (!href.startsWith('http')) {
                            ev.preventDefault();
                            const [fileName, hash] = href.split('#');
                            // ä¼˜å…ˆå¯»æ‰¾å…·ä½“é”šç‚¹ï¼Œå…¶æ¬¡å¯»æ‰¾ç« èŠ‚ ID
                            const target = document.getElementById(hash) || document.getElementById(fileName);
                            if (target) {
                                target.scrollIntoView({ behavior: 'smooth' });
                            }
                        }
                    }
                });

            } catch (err) {
                console.error(err);
                alert("è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¡®ä¿å®ƒæ˜¯æ ‡å‡†çš„ EPUB æ–‡ä»¶ã€‚");
            }
        };

        // è¾…åŠ©ï¼šå¤„ç† HTML ä¸­çš„å›¾ç‰‡è·¯å¾„
        function processHTML(html, baseDir) {
            const doc = new DOMParser().parseFromString(html, "text/html");
            
            // æ›¿æ¢å›¾ç‰‡è·¯å¾„ä¸ºå†…å­˜åœ°å€
            doc.querySelectorAll('img, image').forEach(img => {
                const attr = img.tagName.toLowerCase() === 'img' ? 'src' : 'xlink:href';
                const src = img.getAttribute(attr);
                if (src) {
                    const fullPath = normalizePath(baseDir + src);
                    if (blobs[fullPath]) img.setAttribute(attr, blobs[fullPath]);
                }
            });

            // ç§»é™¤å¯èƒ½å¹²æ‰°çš„å¤–éƒ¨æ ·å¼
            doc.querySelectorAll('link[rel="stylesheet"], style').forEach(s => s.remove());
            
            return doc.body.innerHTML;
        }

        // è¾…åŠ©ï¼šè§„èŒƒåŒ–è·¯å¾„å¤„ç† (a/b/../c -> a/c)
        function normalizePath(path) {
            const parts = path.split('/');
            const stack = [];
            for (let part of parts) {
                if (part === '..') stack.pop();
                else if (part !== '.' && part !== '') stack.push(part);
            }
            return stack.join('/');
        }

        async function findOPF(zip) {
            const container = await zip.file("META-INF/container.xml").async("text");
            const doc = new DOMParser().parseFromString(container, "text/xml");
            return doc.getElementsByTagName("rootfile")[0].getAttribute("full-path");
        }

        function toggleTOC() {
            const side = document.getElementById('sidebar');
            side.style.display = side.style.display === 'block' ? 'none' : 'block';
        }

        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            body.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
        }
    </script>
</body>
</html>